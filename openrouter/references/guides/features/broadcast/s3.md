# S3 / S3-Compatible Storage Integration

OpenRouter enables sending traces to Amazon S3 or S3-compatible storage services including Cloudflare R2 and MinIO.

## Setup Instructions

### Step 1: Create Storage and Credentials

**For AWS S3:**
- Create a new S3 bucket
- Generate IAM user credentials with programmatic access
- Attach a policy granting `s3:PutObject` permissions
- Retrieve Access Key ID and Secret Access Key

**For Cloudflare R2:**
- Create an R2 bucket
- Generate an API token with write permissions
- Collect Access Key ID, Secret Access Key, and S3 endpoint URL

### Step 2: Enable Broadcast Feature

Navigate to Settings > Observability and activate the Broadcast toggle.

### Step 3: Configure S3 Settings

Enter the following information:

- **Bucket Name**: Your storage bucket identifier
- **Region** (optional): AWS region or required for some compatible services
- **Custom Endpoint** (optional): URL for S3-compatible services
- **Access Key Id**: Your access credentials
- **Secret Access Key**: Your secret credentials
- **Session Token** (optional): For temporary credentials
- **Path Template** (optional): Default is `openrouter-traces/{date}`

Available template variables include `{prefix}`, `{date}`, `{year}`, `{month}`, `{day}`, and `{apiKeyName}`.

### Step 4: Verify Connection

Test your configuration before saving. The setup only persists after successful testing.

### Step 5: Send Test Trace

Make an API request through OpenRouter and verify trace files appear in your bucket as `{traceId}-{timestamp}.json`.

## Path Template Organization Examples

- `openrouter-traces/{date}` — Default organization by date
- `traces/{year}/{month}/{day}` — Hierarchical date structure
- `{apiKeyName}/{date}` — Grouped by API key, then date
- `production/llm-traces/{date}` — Environment-based prefixes

## Custom Metadata Support

Custom metadata from the `trace` field appears in stored JSON files within an `metadata` field.

**Supported Keys:**

| Key | Mapping | Purpose |
|-----|---------|---------|
| `trace_id` | `id` (trace level) | Custom identifier |
| `trace_name` | `name` (trace level) | Trace label |
| `span_name` | `name` (observation level) | Span identifier |
| `generation_name` | `name` (observation level) | LLM generation label |

Metadata is queryable via Amazon Athena and similar JSON-aware tools.

## Privacy Mode

When enabled, Privacy Mode excludes prompt and completion text while retaining token counts, costs, timing, model details, and custom metadata.
